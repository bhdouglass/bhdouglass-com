---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import BlogIndex from '../../../../components/BlogIndex.astro';
import { categoriesToTags } from '../../../../utilites';

import '../../../../styles/blog.css';

const title = 'The Voyage of a Software Developer';
const tagline = 'Short posts about software enginering and open source';
const feedUrl = '/feeds/tech.xml';

export async function getStaticPaths({ paginate }) {
  let posts = Astro.fetchContent('../*.md');
  if (process.env.NODE_ENV !== 'development') {
    posts = posts.filter((post) => !post.draft);
  }
  posts.sort((a, b) => (new Date(b.date).valueOf() - new Date(a.date).valueOf()))

  const categories = Array.from(new Set(posts.reduce((acc, cur) => {
    return [...acc, ...categoriesToTags(cur.categories)];
  }, []))).filter((category) => !!category);

  return categories.map((tag) => {
    const filteredPosts = posts.filter((post) => post.categories && post.categories.includes(tag));
    return paginate(filteredPosts, {
      params: { tag },
      pageSize: 30
    });
  });
}

const { page } = Astro.props;
const { params } = Astro.request;
---

<BaseLayout title={title} feedUrl={feedUrl}>
  <BlogIndex
    title={title}
    tagline={tagline}
    posts={page.data}
    nextUrl={page.url.next}
    prevUrl={page.url.prev}
    feedUrl={feedUrl}
    tag={params.tag}
  />
</BaseLayout>
