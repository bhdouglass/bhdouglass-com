---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import BlogIndex from '../../../components/BlogIndex.astro';

import '../../../styles/blog.css';

const title = 'The Voyage of a Software Developer';
const tagline = 'Short posts about software enginering and open source';
const feedUrl = '/feeds/tech.xml';

export async function getStaticPaths({ paginate, rss }) {
  // For some reason you can't pass in variable from outside this scope into here

  let posts = Astro.fetchContent('./*.md');
  if (process.env.NODE_ENV !== 'development') {
    posts = posts.filter((post) => !post.draft);
  }

  posts.sort((a, b) => (new Date(b.date).valueOf() - new Date(a.date).valueOf()))

  rss({
    title: 'The Voyage of a Software Developer by Brian Douglass',
    description: 'Short posts about software enginering and open source',
    items: posts.map(item => {
      let description = item.astro.html.replace(/<[^>]*>/g, '');
      const space = description.substring(0, 200).lastIndexOf(' ');
      description = `${description.substring(0, space)}...`;

      return {
        title: item.title,
        description,
        link: item.url + '?utm_source=rss',
        pubDate: item.date,
      };
    }),
    dest: "/feeds/tech.xml",
  });

  return paginate(posts, { pageSize: 30 });
}

const { page } = Astro.props;
---

<BaseLayout title={title} feedUrl={feedUrl}>
  <BlogIndex
    title={title}
    tagline={tagline}
    posts={page.data}
    nextUrl={page.url.next}
    prevUrl={page.url.prev}
    feedUrl={feedUrl}
  />
</BaseLayout>
